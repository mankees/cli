#!/usr/bin/env node
var VERSION = require('../package.json').version;
var INDEX = 'https://raw.github.com/wiki/bebraw/mankees/Mankees.md';

var fs = require('fs');
var path = require('path');

var marked = require('marked');
var walker = require('filewalker');
var request = require('request');
var program = require('commander');


main();

function main() {
    var mankeeDir = getMankeeDir();

    if(!fs.existsSync(mankeeDir)) {
        return console.error('Create ' + mankeeDir +
            ' and fill it with joy and scripts that export `execute`!');
    }

    getMankees(mankeeDir, run);
}

function run(err, mankees) {
    if(err) return console.error(err);

    program.version(VERSION).
        option('--search', 'search for mankees online').
        option('-i --install', 'install mankee').
        option('-l --list', 'list').
        option('-s --silent', 'silent').
        on('--help', function() {
            var name = last(process.argv);

            if(name == '-h' || name == '--help') return;
            if(name in mankees) {
                return console.log(mankees[name].help || 'No help for this mankee yet!');
            }

            console.error('No mankee found! :(');
        }).parse(process.argv);

    if(program.search) searchMankees(INDEX, program.args[0], function(err, d) {
        if(err) return console.error(err);

        console.log(d);
    });
    else if(program.install) searchMankees(INDEX, program.args[0], function(err, d) {
        if(err) return console.error(err);
        if(d.length > 1) return console.error('Too many matches! Specify mankee by name');

        console.log('should install now');
    });
    else if(program.list) listMankees(mankees);
    else executeMankee(mankees, program.args, program.silent);
}

function last(arr) {
    return arr[arr.length - 1];
}

function getMankeeDir() {
    return path.join(getUserDir(), '.mankees');
}

function getUserDir() {
    // http://stackoverflow.com/a/9081436/228885
    return process.env[(process.platform == 'win32')? 'USERPROFILE': 'HOME'];
}

function getMankees(mankeeDir, cb) {
    var ret = {};
    var mp;

    walker(mankeeDir).on('dir', function(p) {
        if(p.split('/').length == 1) {
            mp = path.join(mankeeDir, p, p);

            try {
                if(fs.existsSync(mp + '.js')) ret[p] = require(mp);
            } catch(e) {
                console.warn('Failed loading ´' + p + '´ mankee!');
            }
        }
    }).on('error', cb).on('done', function() {
        cb(null, ret);
    }).walk();
}

function searchMankees(url, query, cb) {
    request.get({url: url}, function(err, res, data) {
        if(err) return cb(err);

        searchMankee(parseMankees(data), query, cb);
    });
}

function searchMankee(mankees, query, cb) {
    if(!query) return cb(null, mankees);
    var ret;

    query = query.trim();

    mankees.forEach(function(v) {
        if(v.name == query) ret = v;
    });

    if(ret) cb(null, ret);
    else cb('No mankee found!');
}

function parseMankees(data) {
    var lexer = new marked.Lexer();
    var ret = [];
    var withinItem = false;

    lexer.lex(data).forEach(function(v) {
        if(v.type == 'list_item_end') withinItem = false;
        if(withinItem) parseMankee(v.text);
        if(v.type == 'list_item_start') withinItem = true;
    });

    function parseMankee(d) {
        var parts = d.split(' - ');

        ret.push({
            name: parts[0],
            url: parts[1]
        });
    }

    return ret;
}

function listMankees(mankees) {
    var names = Object.keys(mankees);

    if(names.length) console.log(names.join(', '));
    else console.error('No mankees found! :(');
}

function executeMankee(mankees, args, silent) {
    if(!args.length) return console.log('No mankee selected!');

    var name = args.shift();

    if(silent) {
        console.log = noop;
        console.warn = noop;
        console.error = noop;
    }

    if(name in mankees) {
        var mankee = mankees[name];

        if(mankee.execute) mankee.execute.apply(undefined, args);
        else console.error('*' + name + '* mankee is missing `execute`!');
    }
    else console.error('*' + name + '* mankee was not found!');
}

function noop() {}
